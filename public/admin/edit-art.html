<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Edit Artwork — Admin — कला</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    .wrap { max-width:800px; margin:24px auto; padding:18px; }
    .form input, .form textarea { width:100%; padding:10px; border-radius:8px; margin-bottom:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header style="display:flex;justify-content:space-between;align-items:center;">
      <h2>Edit Artwork</h2>
      <div>
        <a class="chip" href="/admin/dashboard.html">Back</a>
      </div>
    </header>

    <form id="editForm" class="form card" style="padding:16px;margin-top:12px;" enctype="multipart/form-data">
      <input name="title" placeholder="Title" required />
      <input name="artist_name" placeholder="Artist name" required />
      <input name="price" type="number" min="0" step="50" placeholder="Price (NPR)" required />
      <input name="category" placeholder="Category (Sketch, Digital...)" />
      <input name="image_url" placeholder="Image URL (hosted) - optional" />
      <input type="file" name="image" accept="image/*" />
      <textarea name="description" placeholder="Short description" rows="4"></textarea>
      <label style="display:flex;gap:8px;align-items:center;margin-top:6px;">
        <input type="checkbox" name="is_sold" /> Mark as sold
      </label>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px;">
        <button class="primary" type="submit">Save</button>
        <a class="ghost" href="/admin/dashboard.html">Cancel</a>
      </div>
      <div id="msg" class="muted" style="margin-top:8px;"></div>
    </form>
  </div>

  <script>
    const form = document.getElementById('editForm');
    const msg = document.getElementById('msg');

    function qs(param) {
      return new URLSearchParams(window.location.search).get(param);
    }
    const id = qs('id');
    if (!id) {
      msg.textContent = 'Missing id';
    } else {
      (async function load(){
        try {
          const res = await fetch('/admin-api/artworks', { credentials: 'include' });
          if (!res.ok) throw res;
          const arts = await res.json();
          const art = arts.find(a => String(a.id) === String(id));
          if (!art) { msg.textContent = 'Not found'; return; }
          form.title.value = art.title || '';
          form.artist_name.value = art.artist_name || '';
          form.price.value = art.price || '';
          form.category.value = art.category || '';
          form.image_url.value = art.image_url || '';
          form.description.value = art.description || '';
          form.is_sold.checked = !!art.is_sold;
        } catch (err) {
          msg.textContent = 'Failed to load';
        }
      })();
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = '';
      const formData = new FormData(form);
      formData.set('price', Number(form.price.value));
      formData.set('is_sold', form.is_sold.checked);
      try {
        const res = await fetch('/admin-api/artworks/' + id, {
          method: 'PUT',
          credentials: 'include',
          body: formData
        });
        if (!res.ok) {
          const d = await res.json().catch(()=>({error:'Failed'}));
          msg.textContent = d.error || 'Failed to save';
          return;
        }
        msg.textContent = 'Saved. Redirecting...';
        setTimeout(()=> window.location.href = '/admin/dashboard.html', 700);
      } catch (err) {
        msg.textContent = 'Network error';
      }
    });
  </script>
</body>
</html>